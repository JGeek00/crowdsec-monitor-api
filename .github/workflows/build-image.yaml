name: Deploy Image to GHCR

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

jobs:
  build-push-image:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: './'
    steps:
      - name: "Checkout GitHub Action"
        uses: actions/checkout@main

      - name: "Login to GitHub Container Registry"
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{github.actor}}
          password: ${{secrets.GH_TOKEN}}

      - name: "Extract version from package.json"
        id: version
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: "Verify changelog exists"
        if: github.ref_type == 'tag'
        run: |
          CHANGELOG_FILE="changelog/${{ github.ref_name }}.md"
          if [ ! -f "$CHANGELOG_FILE" ]; then
            echo "ERROR: Changelog file not found: $CHANGELOG_FILE"
            echo "Please create the changelog file before creating a release."
            exit 1
          fi
          echo "Changelog file found: $CHANGELOG_FILE"
          echo "CHANGELOG_PATH=$CHANGELOG_FILE" >> $GITHUB_ENV

      - name: "Build and push Docker image"
        run: |
          docker build . --tag ghcr.io/jgeek00/crowdsec-monitor-api:latest --tag ghcr.io/jgeek00/crowdsec-monitor-api:${{ steps.version.outputs.VERSION }}
          docker push ghcr.io/jgeek00/crowdsec-monitor-api:latest
          docker push ghcr.io/jgeek00/crowdsec-monitor-api:${{ steps.version.outputs.VERSION }}

      - name: "Create GitHub Release"
        uses: softprops/action-gh-release@v1
        if: github.ref_type == 'tag'
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body_path: ${{ env.CHANGELOG_PATH }}
          token: ${{ secrets.GH_TOKEN }}
